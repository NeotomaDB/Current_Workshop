---
title: "Bison"
author: "Socorro Dominguez"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    fig_caption: yes
    keep_md: yes
    self_contained: yes
    theme: readable
    toc: yes
    toc_float: yes
  pdf_document:
    pandoc_args: "-V geometry:vmargin=1in -V geometry:hmargin=1in"
---

```{r setup, echo=FALSE}
options(warn = -1)
pacman::p_load(neotoma2, dplyr, ggplot2, sf, geojsonsf, leaflet, DT, maptools)
```

## 1. Exercise

Let's try this out :)

1. Let's find all the sites that contain taxa bison (Remember we can use the wild card `%` here)
```{r finding bison}
bison <- get_sites(taxa="%bison%", all_data=TRUE)
```

2. Let's find where they are located:

```{r plot bison sites}
plotLeaflet(bison)
```

Let's retrieve the sample observations. Since there are 1258 sites

```{r obtain records}
#bison_dl <- get_downloads(bison)
bison_dl <- readRDS("data/bisonDataDL.RDS")
```

Let's load in the "translation" table for bison:

```{r translationDisplay}
translation <- readr::read_csv("data/bisontable.csv")
#translation <- translation[-grep('Enophrys', translation$harmonizedname),] ## JESSICA ADDED TO DELETE THE TWO ENOPHRYS ROWS
DT::datatable(translation, rownames = FALSE, 
                options = list(scrollX = "100%", dom = 't'))

```

Let's also take a look at the samples in the `bison_dl` 

```{r viewSamples}
allSamp <- samples(bison_dl)
DT::datatable(head(allSamp))
```

```{r join tables}
allSampDF <- allSamp %>%
  inner_join(translation, by = c("variablename" = "taxa")) %>% 
  dplyr::select(!c("variablename"))
head(allSampDF)
```


``` {r}
allSampDF <- allSampDF %>% 
  group_by(siteid, sitename, harmonizedname,
           sampleid, units, ageyounger, ageolder, 
           agetype, depth, datasetid,
           long, lat) %>%
  summarise(value = sum(value), .groups='keep')
DT::datatable(head(allSampDF))
```
age older or age younger - 

```{r pleistocene and holocene}
allSampDF <- allSampDF %>% 
  mutate(era = ifelse(ageyounger > 11700, "Pleistocene", "Holocene"))

DT::datatable(head(allSampDF))
```





```{r plotting data}
taxaplots <- allSampDF %>%
  group_by(era, harmonizedname) %>%
  filter(!any(is.na(era))) %>% 
  summarise(sites = length(unique(siteid)), samples = length(unique(sampleid)), .groups='keep') %>% 
  arrange(era)

DT::datatable(taxaplots)
```

```{r}
ggplot(data = taxaplots, aes(x = era, y=samples)) +
  geom_bar(stat = 'identity') +
  xlab("Age") +
  ylab("Number of Bison") +
  theme_bw()
```

```{r}
## JESSICA ADDED THIS AS A QUICK EXAMPLE. USES BASE R SINCE THAT'S WHAT I KNOW BEST, MAYBE NOT THE BEST CODE, BUT DOING SOMETHING LIKE THIS MIGHT BE HELPFUL. maybe add a minimum convex polygon around the points for each time period?

xrange<-range(allSampDF$long,na.rm=T)
yrange<-range(allSampDF$lat,na.rm=T)

```

```{r}

data(wrld_simpl)

plot(wrld_simpl,axes=TRUE,col="lightgray", xlim=xrange, ylim=yrange, main="Bison")
points(allSampDF$long[which(allSampDF$era=="Holocene")],allSampDF$lat[which(allSampDF$era=="Holocene")],col="gold",pch=20,cex=0.8)
points(allSampDF$long[which(allSampDF$era=="Pleistocene")],allSampDF$lat[which(allSampDF$era=="Pleistocene")],col="red",pch=20,cex=0.8)
legend(x="bottomleft",legend=c("Holocene","Pleistocene"),pch=20,cex=1.25, col=c("gold","red"), bty="n")

```
